<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ xuất hàng</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }
        td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        td.header { 
            font-weight: bold;
            background-color: #4CAF50 !important;
            color: white !important;
        }
        td:first-child {
            font-weight: bold;
        }
        .subtotal {
            background-color: #E3F2FD;
            color: #333;
            font-weight: bold;
            text-align: left;
        }
        .subtotal td {
            border: 1px solid #ddd;
            font-weight: bold;
        }
        @media print {
            body {
                margin: 0;
                font-size: 12px;
            }
            h2 {
                text-align: center;
            }
            table {
                page-break-inside: auto;
            }
        }
    </style>
</head>
<body>
    <h2>Hồ sơ xuất hàng</h2>
    <table id="datatable">
        <tr>
            <td class="header">Số xe</td>
            <td class="header">Ngày xuất</td>
            <td class="header">Tên NPP</td>
            <td class="header">Material</td>
            <td class="header">Tên gọi tắt</td>
            <td class="header">Thùng</td>
            <td class="header">Mã Pallet</td>
            <td class="header">Ghi chú</td>
            <td class="header">Người xuất</td>
            <td class="header">Biển số xe</td>
        </tr>
    </table>

    <script>
        // Đọc query parameter
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Lấy dữ liệu từ query param 'data'
        const encodedData = getQueryParam('data');
        const table = document.getElementById('datatable');
        const tbody = table.createTBody();

        if (encodedData) {
            try {
                const data = JSON.parse(decodeURIComponent(encodedData));
                // Inject dữ liệu vào bảng
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.insertCell(0).innerText = item.so_xe || '';
                    row.insertCell(1).innerText = item.ngay_xuat || '';
                    row.insertCell(2).innerText = item.ten_npp || '';
                    row.insertCell(3).innerText = item.material || '';
                    row.insertCell(4).innerText = item.ten_goi_tat || '';
                    row.insertCell(5).innerText = item.thung || 0;
                    row.insertCell(6).innerText = item.ma_pallet || '';
                    row.insertCell(7).innerText = item.ghi_chu || '';
                    row.insertCell(8).innerText = item.nguoi_xuat || '';
                    row.insertCell(9).innerText = item.bien_so_xe || '';
                });

                // Gọi hàm nhóm và tính subtotal từ code gốc
                groupAndCalculateSubtotal();
            } catch (e) {
                console.error('Error parsing data:', e);
                const errorRow = tbody.insertRow();
                errorRow.insertCell(0).innerText = 'Lỗi: Không thể đọc dữ liệu. Vui lòng kiểm tra lại JSON.';
                errorRow.cells[0].colSpan = 10;
            }
        } else {
            const noDataRow = tbody.insertRow();
            noDataRow.insertCell(0).innerText = 'Không có dữ liệu.';
            noDataRow.cells[0].colSpan = 10;
        }

        // Hàm nhóm và tính subtotal (giữ nguyên từ code gốc)
        function groupAndCalculateSubtotal() {
            const table = document.getElementById('datatable');
            const rows = Array.from(table.rows).slice(1); // Lấy tất cả các dòng (trừ header).
            const headerRow = table.rows[0]; // Dòng tiêu đề.

            // Sắp xếp các dòng theo Material (tăng dần) và đoạn đầu của Mã Pallet (tăng dần).
            rows.sort((rowA, rowB) => {
                const materialA = rowA.cells[3].innerText.trim();
                const materialB = rowB.cells[3].innerText.trim();
                const palletA = rowA.cells[6].innerText.split('_')[0].trim();
                const palletB = rowB.cells[6].innerText.split('_')[0].trim();

                if (materialA === materialB) {
                    return palletA.localeCompare(palletB);
                }
                return materialA.localeCompare(materialB);
            });

            let currentGroup = null;
            let subtotal = 0;
            let groupRows = [];
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = ''; // Xóa tất cả nội dung để xây dựng lại.

            rows.forEach(row => {
                const material = row.cells[3].innerText.trim();
                const palletGroup = row.cells[6].innerText.split('_')[0].trim();
                const groupKey = `${material}-${palletGroup}`;

                if (currentGroup && currentGroup !== groupKey) {
                    appendSubtotalRow(groupRows, subtotal, tbody);
                    groupRows.forEach(r => tbody.appendChild(r));
                    subtotal = 0;
                    groupRows = [];
                }

                currentGroup = groupKey;
                groupRows.push(row);
                subtotal += parseFloat(row.cells[5].innerText.trim()) || 0;
            });

            if (groupRows.length > 0) {
                appendSubtotalRow(groupRows, subtotal, tbody);
                groupRows.forEach(r => tbody.appendChild(r));
            }

            table.tBodies[0].insertBefore(headerRow, table.tBodies[0].firstChild);
        }

        function appendSubtotalRow(groupRows, subtotal, tbody) {
            const table = document.getElementById('datatable');
            const newRow = table.insertRow();

            for (let i = 0; i < groupRows[0].cells.length; i++) {
                newRow.insertCell(i);
            }

            const material = groupRows[0].cells[3].innerText.trim();
            const palletGroup = groupRows[0].cells[6].innerText.split('_')[0].trim();

            newRow.cells[3].innerText = `${material}`;
            newRow.cells[4].innerText = `Date: ${palletGroup}`;
            newRow.cells[5].innerText = `${subtotal.toFixed(2)}`;

            newRow.classList.add('subtotal');
            groupRows.push(newRow);
        }
    </script>
</body>
</html>
